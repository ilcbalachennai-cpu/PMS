
import * as XLSX from 'xlsx';
import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';
import { Employee, PayrollResult } from '../types';
import { BRAND_CONFIG } from '../constants';

export const generateExcelReport = (data: any[], sheetName: string, fileName: string) => {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, `${fileName}.xlsx`);
};

export const generatePDFTableReport = (
  title: string,
  headers: string[],
  data: (string | number)[][],
  fileName: string,
  orientation: 'p' | 'l' = 'l'
) => {
  const doc = new jsPDF(orientation, 'mm', 'a4');
  
  // Header
  doc.setFontSize(18);
  doc.text(BRAND_CONFIG.companyName, 14, 15);
  doc.setFontSize(11);
  doc.setTextColor(100);
  doc.text(title, 14, 22);
  doc.setTextColor(0);

  // Table
  autoTable(doc, {
    head: [headers],
    body: data,
    startY: 30,
    theme: 'grid',
    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 8 },
    bodyStyles: { fontSize: 8 },
    styles: { cellPadding: 2 }
  });

  // Footer
  const pageCount = doc.getNumberOfPages();
  for(let i = 1; i <= pageCount; i++) {
     doc.setPage(i);
     doc.setFontSize(8);
     doc.setTextColor(150);
     doc.text(`Generated by ${BRAND_CONFIG.appName} on ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
     doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 25, doc.internal.pageSize.height - 10);
  }

  doc.save(`${fileName}.pdf`);
};

export const generatePaySlipsPDF = (
  payrollResults: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('p', 'mm', 'a4');
  
  payrollResults.forEach((res, index) => {
    if (index > 0) doc.addPage();
    const emp = employees.find(e => e.id === res.employeeId);
    if (!emp) return;

    // --- Header ---
    doc.setFillColor(241, 245, 249); // Slate-100
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(30, 41, 59);
    doc.text(BRAND_CONFIG.companyName.toUpperCase(), 105, 18, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(71, 85, 105);
    doc.text("Industrial Estate, Chennai, Tamil Nadu", 105, 25, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(15, 23, 42);
    doc.text(`PAY SLIP - ${month.toUpperCase()} ${year}`, 105, 35, { align: 'center' });

    // --- Employee Details Box ---
    doc.setDrawColor(203, 213, 225);
    doc.rect(14, 45, 182, 35);
    
    const leftX = 18;
    const rightX = 110;
    let y = 52;
    const inc = 6;

    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text("Employee Name:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.name, leftX + 30, y);
    
    doc.setFont("helvetica", "bold");
    doc.text("Designation:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.designation, rightX + 25, y);

    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("Employee ID:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.id, leftX + 30, y);

    doc.setFont("helvetica", "bold");
    doc.text("Department:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.division, rightX + 25, y);

    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("Bank A/c:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.bankAccount, leftX + 30, y);

    doc.setFont("helvetica", "bold");
    doc.text("Days Paid:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(`${res.payableDays} / ${res.daysInMonth}`, rightX + 25, y);
    
    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("UAN No:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.uanc || 'N/A', leftX + 30, y);
    
    doc.setFont("helvetica", "bold");
    doc.text("PF No:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.pfNumber || 'N/A', rightX + 25, y);

    // --- Financials Table ---
    const startY = 85;
    
    autoTable(doc, {
        startY: startY,
        margin: { left: 14, right: 14 },
        head: [['Earnings', 'Amount (Rs.)', 'Deductions', 'Amount (Rs.)']],
        body: [
            ['Basic Pay', res.earnings.basic.toFixed(2), 'Provident Fund', res.deductions.epf.toFixed(2)],
            ['DA', res.earnings.da.toFixed(2), 'Professional Tax', res.deductions.pt.toFixed(2)],
            ['Retaining Allowance', res.earnings.retainingAllowance.toFixed(2), 'ESI', res.deductions.esi.toFixed(2)],
            ['HRA', res.earnings.hra.toFixed(2), 'Income Tax Recovery', res.deductions.it.toFixed(2)],
            ['Conveyance', res.earnings.conveyance.toFixed(2), 'VPF', res.deductions.vpf.toFixed(2)],
            ['Special Allowance', (res.earnings.special1 + res.earnings.special2 + res.earnings.special3).toFixed(2), 'LWF', res.deductions.lwf.toFixed(2)],
            ['Other Allowances', (res.earnings.washing + res.earnings.attire).toFixed(2), 'Advance Recovery', res.deductions.advanceRecovery.toFixed(2)],
            ['Leave Encashment', res.earnings.leaveEncashment.toFixed(2), '', ''],
            [{ content: 'Total Earnings', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.earnings.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: 'Total Deductions', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.deductions.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }],
        ],
        theme: 'grid',
        headStyles: { fillColor: [51, 65, 85], textColor: 255, halign: 'center' },
        columnStyles: {
            0: { cellWidth: 65 },
            1: { cellWidth: 26, halign: 'right' },
            2: { cellWidth: 65 },
            3: { cellWidth: 26, halign: 'right' },
        }
    });

    // --- Net Pay Section ---
    const finalY = (doc as any).lastAutoTable.finalY + 10;
    
    doc.setDrawColor(59, 130, 246); // Blue border
    doc.setLineWidth(0.5);
    doc.rect(14, finalY, 182, 15);
    
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(15, 23, 42);
    doc.text("NET SALARY PAYABLE:", 20, finalY + 10);
    
    doc.setFontSize(14);
    doc.text(`Rs. ${res.netPay.toLocaleString('en-IN')}/-`, 180, finalY + 10, { align: 'right' });

    // --- Footer ---
    doc.setFontSize(8);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(148, 163, 184);
    doc.text("This is a computer-generated document and does not require a signature.", 105, finalY + 30, { align: 'center' });
  });

  doc.save(`PaySlips_${month}_${year}.pdf`);
};

// --- NEW STATUTORY REPORT GENERATORS ---

export const generatePFECR = (results: PayrollResult[], employees: Employee[], format: 'Excel' | 'Text', fileName: string) => {
    const data = results.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        // EPF Wages is capped at 15000 for standard calculation unless higher wages is selected
        const pfWageBase = r.earnings.basic + r.earnings.da + r.earnings.retainingAllowance;
        const cappedWage = Math.min(pfWageBase, 15000);
        
        return {
            UAN: emp?.uanc || '',
            Name: emp?.name || '',
            Gross: r.earnings.total,
            EPF_Wages: emp?.isPFHigherWages ? pfWageBase : cappedWage,
            EPS_Wages: cappedWage, // EPS is strictly capped at 15000
            EDLI_Wages: cappedWage, // EDLI capped at 15000
            EE_Share: r.deductions.epf,
            ER_Share: r.employerContributions.epf,
            EPS_Share: r.employerContributions.eps,
            NCP_Days: r.daysInMonth - r.payableDays,
            Refund: 0
        };
    });

    if (format === 'Excel') {
        generateExcelReport(data, 'ECR Data', fileName);
    } else {
        // Generate Text File (No Header, #~# Separated as per EPFO Unified Portal format)
        const rows = data.map(d => `${d.UAN}#~#${d.Name}#~#${d.Gross}#~#${d.EPF_Wages}#~#${d.EPS_Wages}#~#${d.EDLI_Wages}#~#${d.EE_Share}#~#${d.ER_Share}#~#${d.EPS_Share}#~#${d.NCP_Days}#~#${d.Refund}`).join('\n');
        const blob = new Blob([rows], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
    }
};

export const generateESIReturn = (results: PayrollResult[], employees: Employee[], format: 'Excel' | 'PDF', fileName: string) => {
    const data = results.filter(r => r.deductions.esi > 0).map(r => {
         const emp = employees.find(e => e.id === r.employeeId);
         return {
             'IP Number': emp?.esiNumber || '',
             'IP Name': emp?.name || '',
             'No of Days': r.payableDays,
             'Total Wages': r.earnings.total,
             'IP Contribution': r.deductions.esi,
             'Reason Code': 0,
             'Last Working Day': ''
         };
    });

    if (format === 'Excel') {
        generateExcelReport(data, 'ESI Monthly Return', fileName);
    } else {
        const headers = ['IP Number', 'Name', 'Days', 'Wages', 'ESI Contrib'];
        const rows = data.map(d => [d['IP Number'], d['IP Name'], d['No of Days'], d['Total Wages'], d['IP Contribution']]);
        generatePDFTableReport('Monthly ESI Return', headers, rows as any[][], fileName, 'p');
    }
}

export const generatePTReport = (results: PayrollResult[], employees: Employee[], fileName: string) => {
     const data = results.filter(r => r.deductions.pt > 0).map(r => {
         const emp = employees.find(e => e.id === r.employeeId);
         return [
             emp?.id || '',
             emp?.name || '',
             r.earnings.total,
             r.deductions.pt
         ]
     });
     const headers = ['Emp ID', 'Name', 'Gross Wages', 'PT Deducted'];
     generatePDFTableReport('Professional Tax Report', headers, data as any[][], fileName, 'p');
}

export const generateTDSReport = (results: PayrollResult[], employees: Employee[], fileName: string) => {
     const data = results.filter(r => r.deductions.it > 0).map(r => {
         const emp = employees.find(e => e.id === r.employeeId);
         return [
             emp?.pan || '',
             emp?.name || '',
             r.earnings.total,
             r.deductions.it
         ]
     });
     const headers = ['PAN', 'Name', 'Gross Wages', 'TDS Deducted'];
     generatePDFTableReport('Income Tax Deduction Report', headers, data as any[][], fileName, 'p');
}
