
import * as XLSX from 'xlsx';
import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';
import { Employee, PayrollResult, StatutoryConfig, Attendance, LeaveLedger, AdvanceLedger, CompanyProfile } from '../types';
import { BRAND_CONFIG } from '../constants';

// --- Utility: Number to Words (Indian System) ---
export const numberToWords = (num: number): string => {
  const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
  const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

  const numToWordsInner = (input: number): string => {
    if (input === 0) return '';
    if (input >= 10000000) return numToWordsInner(Math.floor(input / 10000000)) + 'Crore ' + numToWordsInner(input % 10000000);
    if (input >= 100000) return numToWordsInner(Math.floor(input / 100000)) + 'Lakh ' + numToWordsInner(input % 100000);
    if (input >= 1000) return numToWordsInner(Math.floor(input / 1000)) + 'Thousand ' + numToWordsInner(input % 1000);
    if (input >= 100) return numToWordsInner(Math.floor(input / 100)) + 'Hundred ' + numToWordsInner(input % 100);
    if (input < 20) return a[input];
    const s = input.toString();
    return b[parseInt(s[0])] + ' ' + a[parseInt(s[1])];
  };

  const integerPart = Math.floor(num);
  if (integerPart === 0) return 'Zero';
  return numToWordsInner(integerPart).trim();
};

const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

export const generateExcelReport = (data: any[], sheetName: string, fileName: string) => {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, `${fileName}.xlsx`);
};

export const generatePDFTableReport = (
  title: string,
  headers: string[],
  data: (string | number)[][],
  fileName: string,
  orientation: 'p' | 'l' = 'l',
  footnote?: string,
  companyProfile?: CompanyProfile
) => {
  const doc = new jsPDF(orientation, 'mm', 'a4');
  doc.setFontSize(18);
  const companyName = companyProfile?.establishmentName || BRAND_CONFIG.companyName;
  doc.text(companyName, 14, 15);

  doc.setFontSize(8);
  if (companyProfile) {
      const addressLine = `${companyProfile.address}, ${companyProfile.city}, ${companyProfile.state}`.replace(/,\s*,/g, ',');
      doc.text(addressLine, 14, 19);
  }

  doc.setFontSize(11);
  doc.setTextColor(100);
  doc.text(title, 14, 24);
  doc.setTextColor(0);

  autoTable(doc, {
    head: [headers],
    body: data,
    startY: 32,
    theme: 'grid',
    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 8 },
    bodyStyles: { fontSize: 7 },
    styles: { cellPadding: 1 }
  });

  const pageCount = doc.getNumberOfPages();
  const finalY = (doc as any).lastAutoTable.finalY + 10;

  if (footnote) {
      doc.setFontSize(8);
      doc.setFont("helvetica", "italic");
      doc.setTextColor(0);
      const printY = finalY > doc.internal.pageSize.height - 20 ? doc.internal.pageSize.height - 20 : finalY;
      const splitFootnote = doc.splitTextToSize(footnote, 180);
      doc.text(splitFootnote, 14, printY);
  }

  for(let i = 1; i <= pageCount; i++) {
     doc.setPage(i);
     doc.setFontSize(8);
     doc.setTextColor(150);
     doc.text(`Generated by ${BRAND_CONFIG.appName} on ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
     doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 25, doc.internal.pageSize.height - 10);
  }

  doc.save(`${fileName}.pdf`);
};

export const generateSimplePaySheetPDF = (
  results: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number,
  companyProfile?: CompanyProfile
) => {
  const headers = ['ID', 'Name', 'Days', 'Basic', 'DA', 'Retn', 'HRA', 'Conv', 'Spec', 'Othr', 'Encash', 'GROSS', 'PF', 'VPF', 'ESI', 'PT', 'TDS', 'LWF', 'Adv', 'DED', 'NET PAY'];
  const data = results.map(r => {
    const emp = employees.find(e => e.id === r.employeeId);
    const special = r.earnings.special1 + r.earnings.special2 + r.earnings.special3;
    const other = r.earnings.washing + r.earnings.attire;
    return [
      r.employeeId, emp?.name || '', r.payableDays, Math.round(r.earnings.basic), Math.round(r.earnings.da), Math.round(r.earnings.retainingAllowance), Math.round(r.earnings.hra), Math.round(r.earnings.conveyance), Math.round(special), Math.round(other), Math.round(r.earnings.leaveEncashment), Math.round(r.earnings.total), r.isCode88 ? `${Math.round(r.deductions.epf)}*` : Math.round(r.deductions.epf), Math.round(r.deductions.vpf), r.isESICodeWagesUsed ? `${Math.round(r.deductions.esi)}**` : Math.round(r.deductions.esi), Math.round(r.deductions.pt), Math.round(r.deductions.it), Math.round(r.deductions.lwf), Math.round(r.deductions.advanceRecovery), Math.round(r.deductions.total), Math.round(r.netPay)
    ];
  });
  let footnote = results.some(r => r.isCode88) ? "* PF calculated on Code Wages. " : "";
  footnote += results.some(r => r.isESICodeWagesUsed) ? "** ESI calculated on Code Wages." : "";
  generatePDFTableReport(`Pay Sheet - ${month} ${year}`, headers, data as any[][], `PaySheet_${month}_${year}`, 'l', footnote || undefined, companyProfile);
};

export const generatePaySlipsPDF = (
  payrollResults: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number,
  companyProfile?: CompanyProfile
) => {
  const doc = new jsPDF('p', 'mm', 'a4');
  payrollResults.forEach((res, index) => {
    if (index > 0) doc.addPage();
    const emp = employees.find(e => e.id === res.employeeId);
    if (!emp) return;

    doc.setFillColor(241, 245, 249);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFontSize(20); doc.setFont("helvetica", "bold"); doc.setTextColor(30, 41, 59);
    doc.text((companyProfile?.establishmentName || BRAND_CONFIG.companyName).toUpperCase(), 105, 18, { align: 'center' });
    doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.setTextColor(71, 85, 105);
    const address = companyProfile ? `${companyProfile.address}, ${companyProfile.city}, ${companyProfile.state}` : "Industrial Estate, Chennai, Tamil Nadu";
    doc.text(address, 105, 25, { align: 'center' });
    doc.setFontSize(12); doc.setTextColor(15, 23, 42); doc.text(`PAY SLIP - ${month.toUpperCase()} ${year}`, 105, 35, { align: 'center' });

    doc.setDrawColor(203, 213, 225); doc.rect(14, 45, 182, 35);
    let y = 52;
    doc.setFontSize(9); doc.setFont("helvetica", "bold");
    doc.text("Employee Name:", 18, y); doc.setFont("helvetica", "normal"); doc.text(emp.name, 48, y);
    doc.setFont("helvetica", "bold"); doc.text("Designation:", 110, y); doc.setFont("helvetica", "normal"); doc.text(emp.designation, 135, y);
    y += 6;
    doc.text("Employee ID:", 18, y); doc.text(emp.id, 48, y); doc.text("Department:", 110, y); doc.text(emp.division, 135, y);
    y += 6;
    doc.text("Bank A/c:", 18, y); doc.text(emp.bankAccount, 48, y); doc.text("Days Paid:", 110, y); doc.text(`${res.payableDays} / ${res.daysInMonth}`, 135, y);
    y += 6;
    doc.text("UAN No:", 18, y); doc.text(emp.uanc || 'N/A', 48, y); doc.text("PF No:", 110, y); doc.text(emp.pfNumber || 'N/A', 135, y);

    autoTable(doc, {
        startY: 85, margin: { left: 14, right: 14 },
        head: [['Earnings', 'Amount (Rs.)', 'Deductions', 'Amount (Rs.)']],
        body: [
            ['Basic Pay', res.earnings.basic.toFixed(2), res.isCode88 ? 'Provident Fund*' : 'Provident Fund', res.deductions.epf.toFixed(2)],
            ['DA', res.earnings.da.toFixed(2), res.isESICodeWagesUsed ? 'ESI**' : 'ESI', res.deductions.esi.toFixed(2)],
            ['Retaining Allowance', res.earnings.retainingAllowance.toFixed(2), 'Professional Tax', res.deductions.pt.toFixed(2)],
            ['HRA', res.earnings.hra.toFixed(2), 'Income Tax Recovery', res.deductions.it.toFixed(2)],
            ['Conveyance', res.earnings.conveyance.toFixed(2), 'VPF', res.deductions.vpf.toFixed(2)],
            ['Special Allowance', (res.earnings.special1 + res.earnings.special2 + res.earnings.special3).toFixed(2), 'LWF', res.deductions.lwf.toFixed(2)],
            ['Other Allowances', (res.earnings.washing + res.earnings.attire).toFixed(2), 'Advance Recovery', res.deductions.advanceRecovery.toFixed(2)],
            ['Leave Encashment', res.earnings.leaveEncashment.toFixed(2), '', ''],
            [{ content: 'Total Earnings', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.earnings.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: 'Total Deductions', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.deductions.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }],
        ],
        theme: 'grid', headStyles: { fillColor: [51, 65, 85], textColor: 255, halign: 'center' }
    });

    const finalY = (doc as any).lastAutoTable.finalY + 10;
    doc.rect(14, finalY, 182, 15); doc.setFontSize(11); doc.setFont("helvetica", "bold");
    doc.text("NET SALARY PAYABLE:", 20, finalY + 10);
    doc.setFontSize(14); doc.text(`Rs. ${Math.round(res.netPay).toLocaleString('en-IN')}/-`, 180, finalY + 10, { align: 'right' });
    doc.setFontSize(10); doc.text(`Amount in Words: ${numberToWords(Math.round(res.netPay))} Rupees Only`, 14, finalY + 25);
    doc.setFontSize(8); doc.setFont("helvetica", "italic"); doc.setTextColor(148, 163, 184);
    doc.text("This is a computer-generated document and does not require a signature.", 105, finalY + 35, { align: 'center' });
  });
  doc.save(`PaySlips_${month}_${year}.pdf`);
};

export const generateLeaveLedgerReport = (employees: Employee[], leaveLedgers: LeaveLedger[], attendances: Attendance[], month: string, year: number, type: 'BC' | 'AC', companyProfile?: CompanyProfile) => {
    const headers = ['ID', 'Name', 'EL Opening', 'EL Credit', 'EL Availed', 'EL Balance', 'SL Opening', 'SL Credit', 'SL Availed', 'SL Balance', 'CL Opening', 'CL Credit', 'CL Availed', 'CL Balance'];
    const data = employees.map(emp => {
        const ledger = leaveLedgers.find(l => l.employeeId === emp.id);
        const att = attendances.find(a => a.employeeId === emp.id && a.month === month && a.year === year);
        const elOpen = ledger?.el.opening || 0, elCredit = ledger?.el.eligible || 0, elAvailed = (att?.earnedLeave || 0) + (att?.encashedDays || 0);
        return [emp.id, emp.name, elOpen, elCredit, elAvailed, elOpen + elCredit - elAvailed, ledger?.sl.eligible || 0, 0, att?.sickLeave || 0, (ledger?.sl.eligible || 0) - (att?.sickLeave || 0), ledger?.cl.accumulation || 0, 0, att?.casualLeave || 0, (ledger?.cl.accumulation || 0) - (att?.casualLeave || 0)];
    });
    generatePDFTableReport(type === 'BC' ? `Leave Ledger (Before Confirmation) - ${month} ${year}` : `Leave Ledger (After Confirmation) - ${month} ${year}`, headers, data as any[][], `Leave_Ledger_${type}_${month}_${year}`, 'l', undefined, companyProfile);
};

export const generatePFForm12A = (data: PayrollResult[], employees: Employee[], config: StatutoryConfig, companyProfile: CompanyProfile, month: string, year: number) => {
    const doc = new jsPDF('p', 'mm', 'a4');
    const width = doc.internal.pageSize.getWidth();

    // 1. Header Section
    doc.setFont("helvetica", "bold");
    doc.setTextColor(220, 38, 38); // Red Color
    doc.setFontSize(11);
    doc.text("PF_Form12A (Revised)", width / 2, 10, { align: 'center' });
    
    doc.setTextColor(0); // Reset to Black
    doc.setFontSize(9);
    doc.text("(Only for Un-Exempted Establishment)", 14, 15);

    // Left Side: Establishment Details
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text("Name Address of Establishment", 14, 22);
    
    doc.setFont("helvetica", "bold");
    doc.text((companyProfile?.establishmentName || BRAND_CONFIG.companyName).toUpperCase(), 14, 27);
    
    doc.setFont("helvetica", "normal");
    const addressLines = doc.splitTextToSize(
        `${companyProfile?.address || ''}\n${companyProfile?.city || ''}, ${companyProfile?.state || ''}`, 
        80
    );
    doc.text(addressLines, 14, 32);

    // Right Side: Act Details & Codes
    const rightX = 100;
    doc.text("| Employees Provident Fund And Misc. Provision Act 1952", rightX, 15);
    doc.text("| Employees Pension Scheme [Paragraph 20 (4)]", rightX, 20);
    
    // Currency Period
    const nextMonthIdx = (MONTHS.indexOf(month) + 1) % 12; // Simple next month logic roughly
    // Better logic: Current month start to end
    const daysInMonth = new Date(year, MONTHS.indexOf(month) + 1, 0).getDate();
    doc.text(`| Currency Period from: 1st ${month} to ${daysInMonth} ${month}`, rightX, 25);
    doc.text(`| Statement of Contribution for the Month of ${month} ${year}`, rightX, 30);
    
    doc.text("| (To be Filled by the EPFO)", rightX, 35);
    doc.text("| Establishment Status", rightX, 40);
    doc.text("| Group Code", rightX, 45);
    doc.text("| Establishment Code", rightX, 50);

    // 2. Red Calculation Sheet Header
    const calcY = 60;
    doc.setDrawColor(220, 38, 38);
    doc.setLineWidth(0.5);
    doc.line(14, calcY, width - 14, calcY);
    doc.setTextColor(220, 38, 38);
    doc.setFont("helvetica", "bold");
    doc.text("PF ECR_UAN_CALCULATION SHEET", width / 2, calcY - 2, { align: 'center' });
    doc.line(14, calcY - 6, width - 14, calcY - 6); // Top line

    // 3. TRRN and Date Boxes (Yellow Highlight)
    const boxY = calcY + 5;
    doc.setFillColor(255, 255, 0); // Yellow
    doc.rect(70, boxY, 20, 6, 'F'); // TRRN Label Box
    doc.setTextColor(0);
    doc.setFontSize(9);
    doc.text("TRRN", 80, boxY + 4, { align: 'center' });
    
    doc.setFillColor(255, 255, 0); // Yellow
    doc.rect(150, boxY, 20, 6, 'F'); // Date Label Box
    doc.text("Date", 160, boxY + 4, { align: 'center' });

    // 4. Calculations
    let totalEPFWages = 0;
    let totalEPSWages = 0;
    let totalEDLIWages = 0;
    let totalEE_Share = 0; // 12%
    let totalER_EPF_Share = 0; // 3.67%
    let totalER_EPS_Share = 0; // 8.33%

    // Calculate Totals strictly
    data.forEach(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        
        // Wages
        const actualWage = r.earnings.basic + r.earnings.da + r.earnings.retainingAllowance;
        
        // EPF Wages: Actual if Higher Wages opted, else capped at 15k
        const epfWage = emp?.isPFHigherWages ? actualWage : Math.min(actualWage, config.epfCeiling);
        totalEPFWages += Math.round(epfWage);

        // EPS Wages: Always capped at 15k (unless Higher Pension enabled - check flag)
        const epsWage = (emp?.pfHigherPension?.enabled && emp.pfHigherPension.isHigherPensionOpted === 'Yes') 
            ? actualWage 
            : Math.min(actualWage, 15000); // Standard EPS Cap
        totalEPSWages += Math.round(epsWage);

        // EDLI Wages: Same as EPS usually
        totalEDLIWages += Math.round(Math.min(actualWage, 15000));

        // Shares
        totalEE_Share += (r.deductions.epf); // Assuming VPF is separate, Form 12A usually tracks statutory 12%
        totalER_EPS_Share += r.employerContributions.eps;
        totalER_EPF_Share += r.employerContributions.epf;
    });

    const adminCharges = Math.round(totalEPFWages * 0.005); // A/c 2
    const edliCharges = Math.round(totalEDLIWages * 0.005); // A/c 21 (EDLI Contribution, confusingly labeled as Charges in some contexts, but row 3 is wages)
    
    // Correcting Row 3 based on Screenshot: "EDLI_Wages (A/c No.21)" -> This is the 0.5% Contribution
    // Row 3 Total = 0.5% of EDLI Wages
    const ac21_Amount = edliCharges;

    // Row 4: Admin Charges (A/c No.2) -> 0.5% of PF Wages
    const ac2_Amount = Math.max(500, adminCharges); // Min 500 usually applies to challan, showing calc here

    const totalColumnSum = (totalEE_Share) + (totalER_EPF_Share) + (totalER_EPS_Share) + (ac21_Amount) + (ac2_Amount);

    // 5. Table Data Construction
    const tableData = [
        [
            { content: 'EPF_Wages (A/c No.1)\n(12%+3.67%)', styles: { fontStyle: 'bold' } },
            totalEPFWages,
            '12%',
            totalEE_Share,
            '3.67%',
            totalER_EPF_Share,
            totalEE_Share + totalER_EPF_Share
        ],
        [
            { content: 'EPS_Wages (A/c No.10)\n(8.33%)', styles: { fontStyle: 'bold' } },
            totalEPSWages,
            '',
            '',
            '8.33%',
            totalER_EPS_Share,
            totalER_EPS_Share
        ],
        [
            { content: 'EDLI_Wages (A/c No.21)\n(0.50%)', styles: { fontStyle: 'bold' } },
            totalEDLIWages,
            '',
            '',
            '',
            '',
            ac21_Amount
        ],
        [
            { content: 'Admin_Charges (A/c No.2)\n(0.50%)', styles: { fontStyle: 'bold' } },
            totalEPFWages,
            '',
            '',
            '',
            '',
            ac2_Amount
        ],
        [
            { content: 'Admin_Charg_EDLI (0.0%)', styles: { fontStyle: 'bold' } },
            '0',
            '',
            '',
            '',
            '',
            '0'
        ],
        [
            '',
            '',
            { content: totalEE_Share, styles: { fontStyle: 'bold' } },
            '', // Merged visually by placement
            { content: (totalER_EPF_Share + totalER_EPS_Share), styles: { fontStyle: 'bold' } }, // Employer Total
            '',
            { content: totalColumnSum, styles: { fontStyle: 'bold' } }
        ]
    ];

    autoTable(doc, {
        startY: boxY + 15,
        head: [['PF-Wages', 'Wages', 'Employee Share', '', 'Employer Share', '', 'Total']], // Simplified Header to match visual
        body: tableData as any,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 2, overflow: 'visible' },
        columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 30 },
            2: { cellWidth: 20 }, // Emp Rate
            3: { cellWidth: 25 }, // Emp Amt
            4: { cellWidth: 20 }, // Er Rate
            5: { cellWidth: 25 }, // Er Amt
            6: { cellWidth: 25, halign: 'right' } // Total
        },
        didParseCell: (data) => {
            // Header Customization
            if (data.section === 'head') {
                if (data.column.index === 0) data.cell.text = ['PF-Wages'];
                if (data.column.index === 1) data.cell.text = [totalEPFWages.toString()]; // Show Total Wages in Header line as per screenshot
                if (data.column.index === 2) data.cell.text = ['Employee Share'];
                if (data.column.index === 4) data.cell.text = ['Employer Share'];
                if (data.column.index === 6) data.cell.text = ['Total'];
                
                // Clear others
                if ([3, 5].includes(data.column.index)) data.cell.text = [''];
                
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.textColor = 0;
            }
        },
        // Draw lines manually for "Grand Total" effect
        didDrawPage: (data) => {
            const lastY = data.cursor?.y || 0;
            doc.setDrawColor(200);
            doc.line(14, lastY - 10, width - 14, lastY - 10); // Line above Total
            doc.line(14, lastY, width - 14, lastY); // Line below Total
        }
    });

    doc.save(`PF_Form12A_Revised_${month}_${year}.pdf`);
};

export const generatePFForm12 = (data: PayrollResult[], employees: Employee[], config: StatutoryConfig, month: string, year: number, companyProfile: CompanyProfile) => {
    // Old format (Re-using logic but different simple table)
    generatePFForm12A(data, employees, config, companyProfile, month, year);
};

export const generatePFECR = (data: PayrollResult[], employees: Employee[], format: 'Excel' | 'Text', fileName: string) => {
    const ecrData = data.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        const pfWage = r.earnings.basic + r.earnings.da + r.earnings.retainingAllowance;
        return {
            UAN: emp?.uanc, Name: emp?.name, Gross: r.earnings.total, EPF: pfWage, EPS: Math.min(pfWage, 15000), EDLI: Math.min(pfWage, 15000), EE_Share: r.deductions.epf, ER_Share_EPF: r.employerContributions.epf, ER_Share_EPS: r.employerContributions.eps, NCP_Days: r.daysInMonth - r.payableDays, Refund: 0
        };
    });
    if (format === 'Excel') generateExcelReport(ecrData, 'ECR', fileName);
    else {
        const textContent = ecrData.map(d => Object.values(d).join('#~#')).join('\n');
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${fileName}.txt`; a.click();
    }
};

export const generateESIReturn = (data: PayrollResult[], employees: Employee[], format: 'Excel' | 'Text', fileName: string, companyProfile: CompanyProfile) => {
    const esiData = data.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return { IP_Number: emp?.esiNumber, IP_Name: emp?.name, No_of_Days: r.payableDays, Total_Monthly_Wages: r.earnings.total, Reason_Code_Zero_Wages: r.payableDays === 0 ? 1 : 0, Last_Working_Day: '' };
    });
    generateExcelReport(esiData, 'ESI_Return', fileName);
};

export const generatePTReport = (data: PayrollResult[], employees: Employee[], fileName: string, companyProfile: CompanyProfile) => {
     const ptData = data.filter(r => r.deductions.pt > 0).map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return { Emp_ID: r.employeeId, Name: emp?.name, Gross_Wages: r.earnings.total, PT_Deducted: r.deductions.pt };
    });
    generateExcelReport(ptData, 'Professional Tax', fileName);
};

export const generateTDSReport = (data: PayrollResult[], employees: Employee[], fileName: string, companyProfile: CompanyProfile) => {
     const tdsData = data.filter(r => r.deductions.it > 0).map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return { Emp_ID: r.employeeId, Name: emp?.name, PAN: emp?.pan, Gross_Wages: r.earnings.total, TDS_Deducted: r.deductions.it };
    });
    generateExcelReport(tdsData, 'TDS Report', fileName);
};

export const generateCodeOnWagesReport = (data: PayrollResult[], employees: Employee[], format: 'Excel' | 'PDF', fileName: string, companyProfile: CompanyProfile) => {
     const reportData = data.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        const basicWages = r.earnings.basic + r.earnings.da + r.earnings.retainingAllowance;
        const totalWages = r.earnings.total;
        const excludedWages = totalWages - basicWages;
        const limit = totalWages * 0.5;
        const excess = excludedWages > limit ? excludedWages - limit : 0;
        return { Emp_ID: r.employeeId, Name: emp?.name, Gross_Wages: totalWages, Basic_DA: basicWages, Allowances: excludedWages, '50%_Limit': limit, Excess_Over_50: excess, Deemed_Wages: basicWages + excess, PF_Wages_Used: r.isCode88 ? basicWages + excess : Math.min(15000, basicWages) };
    });
    if (format === 'Excel') generateExcelReport(reportData, 'Code on Wages', fileName);
    else {
        const headers = ['ID', 'Name', 'Gross', 'Basic+DA', 'Allw', '50% Lim', 'Excess', 'Deemed Wages'];
        const tableData = reportData.map(d => [d.Emp_ID, d.Name, d.Gross_Wages, d.Basic_DA, d.Allowances, d['50%_Limit'], d.Excess_Over_50, d.Deemed_Wages]);
        generatePDFTableReport('Impact of Code on Wages, 2020', headers, tableData as any[][], fileName, 'l', undefined, companyProfile);
    }
};

export const generateFormB = (data: PayrollResult[], employees: Employee[], month: string, year: number, companyProfile: CompanyProfile) => {
    const headers = ['Sl', 'Name', 'Designation', 'Total Days', 'Total Wages', 'Deductions', 'Net Payable'];
    const tableData = data.map((r, i) => {
         const emp = employees.find(e => e.id === r.employeeId);
         return [i+1, emp?.name, emp?.designation, r.payableDays, r.earnings.total, r.deductions.total, r.netPay];
    });
    generatePDFTableReport(`Form B (Register of Wages) - ${month} ${year}`, headers, tableData as any[][], `FormB_${month}_${year}`, 'l', undefined, companyProfile);
};

export const generateCentralWageSlip = (data: PayrollResult[], employees: Employee[], month: string, year: number) => {
    generatePaySlipsPDF(data, employees, month, year); 
};

export const generateFormC = (data: PayrollResult[], employees: Employee[], attendances: Attendance[], month: string, year: number, companyProfile: CompanyProfile) => {
    const headers = ['Sl', 'Name', 'Father/Husband', 'Sex', 'Nature of Work', 'Attendance (Days)'];
    const tableData = data.map((r, i) => {
         const emp = employees.find(e => e.id === r.employeeId);
         const att = attendances.find(a => a.employeeId === r.employeeId && a.month === month && a.year === year);
         return [i+1, emp?.name, emp?.fatherSpouseName, emp?.gender || 'M', emp?.designation, att?.presentDays || 0];
    });
    generatePDFTableReport(`Form C (Muster Roll) - ${month} ${year}`, headers, tableData as any[][], `FormC_${month}_${year}`, 'l', undefined, companyProfile);
};

export const generateTNFormR = (data: PayrollResult[], employees: Employee[], month: string, year: number, companyProfile: CompanyProfile) => {
     generateFormB(data, employees, month, year, companyProfile);
};

export const generateTNFormT = (data: PayrollResult[], employees: Employee[], attendances: Attendance[], leaveLedgers: LeaveLedger[], month: string, year: number, companyProfile: CompanyProfile) => {
     generatePaySlipsPDF(data, employees, month, year, companyProfile);
};

export const generateTNFormP = (data: PayrollResult[], employees: Employee[], advanceLedgers: AdvanceLedger[], month: string, year: number, companyProfile: CompanyProfile) => {
     const headers = ['Sl', 'Name', 'Date of Adv', 'Amount', 'Purpose', 'Installments', 'Recovered', 'Balance'];
     const tableData = advanceLedgers.map((adv, i) => {
         const emp = employees.find(e => e.id === adv.employeeId);
         const payroll = data.find(p => p.employeeId === adv.employeeId);
         const recovered = payroll ? payroll.deductions.advanceRecovery : 0;
         return [i+1, emp?.name, 'Various', adv.totalAdvance, 'Personal', adv.monthlyInstallment, recovered, adv.balance];
     });
     generatePDFTableReport(`Form P (Register of Advances) - ${month} ${year}`, headers, tableData as any[][], `FormP_${month}_${year}`, 'l', undefined, companyProfile);
};

export const generateESIExitReport = (data: PayrollResult[], employees: Employee[], month: string, year: number, companyProfile: CompanyProfile) => {
     const exitData = data.filter(r => r.esiRemark === 'IP is out of coverage').map(r => {
         const emp = employees.find(e => e.id === r.employeeId);
         return { ID: r.employeeId, Name: emp?.name, Gross_Wages: r.earnings.total, Reason: r.esiRemark };
     });
     generateExcelReport(exitData, 'ESI Exit List', `ESI_Exit_${month}_${year}`);
};

export const generateESICodeWagesReport = (data: PayrollResult[], employees: Employee[], format: 'Excel' | 'PDF', fileName: string, companyProfile: CompanyProfile) => {
    const reportData = data.filter(r => r.isESICodeWagesUsed).map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return { ID: r.employeeId, Name: emp?.name, Actual_Gross: r.earnings.total, ESI_Code_Wages: r.earnings.total };
    });
    if (format === 'Excel') generateExcelReport(reportData, 'ESI Code Wages', fileName);
    else {
        const headers = ['ID', 'Name', 'Actual Gross', 'ESI Code Wages'];
        const tableData = reportData.map(d => [d.ID, d.Name, d.Actual_Gross, d.ESI_Code_Wages]);
        generatePDFTableReport('ESI Contribution on Code Wages', headers, tableData as any[][], fileName, 'p', undefined, companyProfile);
    }
};

const getMonthsInRange = (startMonth: string, startYear: number, endMonth: string, endYear: number) => {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const result = [];
  let currentY = startYear;
  let currentMIdx = months.indexOf(startMonth);
  const endMIdx = months.indexOf(endMonth);
  
  // Safety break
  let count = 0;
  while(count < 24) { // Max 2 years loop
      result.push({ month: months[currentMIdx], year: currentY });
      if (currentY === endYear && currentMIdx === endMIdx) break;
      
      currentMIdx++;
      if (currentMIdx > 11) {
          currentMIdx = 0;
          currentY++;
      }
      count++;
  }
  return result;
};

export const generatePFForm3A = (
  payrollHistory: PayrollResult[], 
  employees: Employee[], 
  config: StatutoryConfig, 
  startMonth: string, 
  startYear: number, 
  endMonth: string, 
  endYear: number, 
  targetEmployeeId: string | undefined, 
  companyProfile: CompanyProfile
) => {
    const doc = new jsPDF('p', 'mm', 'a4');
    const periods = getMonthsInRange(startMonth, startYear, endMonth, endYear);
    
    // Determine employees to process
    let employeesToProcess = employees;
    if (targetEmployeeId) {
        employeesToProcess = employees.filter(e => e.id === targetEmployeeId);
    }
    
    // Sort employees by ID
    employeesToProcess.sort((a, b) => a.id.localeCompare(b.id));

    employeesToProcess.forEach((emp, index) => {
        if (index > 0) doc.addPage();
        
        // Header
        doc.setFontSize(14); doc.setFont("helvetica", "bold");
        doc.text("FORM 3A (Revised)", 105, 10, { align: "center" });
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text("(For Un-Exempted Establishments)", 105, 15, { align: "center" });
        
        doc.setFontSize(10);
        doc.text(`Currency Period: ${startMonth} ${startYear} to ${endMonth} ${endYear}`, 14, 25);
        
        // Establishment Details
        doc.setFont("helvetica", "bold");
        doc.text("1. Name & Address of Establishment:", 14, 32);
        doc.setFont("helvetica", "normal");
        doc.text(companyProfile.establishmentName, 80, 32);
        doc.text(`${companyProfile.address}, ${companyProfile.city}`, 80, 37);
        
        doc.setFont("helvetica", "bold");
        doc.text("2. Establishment Code:", 14, 45);
        doc.setFont("helvetica", "normal");
        doc.text(companyProfile.pfCode || "N/A", 80, 45);

        // Employee Details
        doc.setFont("helvetica", "bold");
        doc.text("3. Name of Member:", 14, 52);
        doc.setFont("helvetica", "normal");
        doc.text(emp.name, 80, 52);
        
        doc.setFont("helvetica", "bold");
        doc.text("4. Father's/Spouse's Name:", 14, 57);
        doc.setFont("helvetica", "normal");
        doc.text(emp.fatherSpouseName || "", 80, 57);
        
        doc.setFont("helvetica", "bold");
        doc.text("5. Account No:", 14, 62);
        doc.setFont("helvetica", "normal");
        doc.text(emp.pfNumber || "", 80, 62);
        
        // Table Data
        const bodyData = periods.map(p => {
            const record = payrollHistory.find(r => r.employeeId === emp.id && r.month === p.month && r.year === p.year);
            if (!record) return [p.month, 0, 0, 0, 0, 0];
            
            const wage = record.earnings.basic + record.earnings.da + record.earnings.retainingAllowance;
            const epfWage = emp.isPFHigherWages ? wage : Math.min(wage, config.epfCeiling);
            
            return [
                p.month + " " + p.year,
                Math.round(epfWage), // Amount of Wages
                Math.round(record.deductions.epf), // EPF (EE Share)
                Math.round(record.employerContributions.eps), // EPS (ER Share) - 8.33%
                Math.round(record.employerContributions.epf), // EPF (ER Share) - 3.67%
                0 // Refund of Advances (Placeholder)
            ];
        });
        
        // Totals
        const totalWages = bodyData.reduce((acc, curr) => acc + (curr[1] as number), 0);
        const totalEE = bodyData.reduce((acc, curr) => acc + (curr[2] as number), 0);
        const totalEPS = bodyData.reduce((acc, curr) => acc + (curr[3] as number), 0);
        const totalER_EPF = bodyData.reduce((acc, curr) => acc + (curr[4] as number), 0);

        bodyData.push(['TOTAL', totalWages, totalEE, totalEPS, totalER_EPF, 0]);

        autoTable(doc, {
            startY: 70,
            head: [['Month', 'Wages', 'EPF Share (EE)', 'EPS Share (ER)', 'EPF Share (ER)', 'Refund of Adv']],
            body: bodyData,
            theme: 'grid',
            headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' },
            styles: { fontSize: 9 }
        });
        
        const finalY = (doc as any).lastAutoTable.finalY + 10;
        doc.text("Certified that the amount of contribution deducted from wages has been deposited.", 14, finalY);
        doc.text("Signature of Employer", 140, finalY + 15);
    });

    doc.save(`Form3A_${startMonth}${startYear}_${endMonth}${endYear}.pdf`);
};

export const generatePFForm6A = (
  payrollHistory: PayrollResult[], 
  employees: Employee[], 
  config: StatutoryConfig, 
  startMonth: string, 
  startYear: number, 
  endMonth: string, 
  endYear: number, 
  companyProfile: CompanyProfile
) => {
    const doc = new jsPDF('l', 'mm', 'a4');
    const periods = getMonthsInRange(startMonth, startYear, endMonth, endYear);

    // Header
    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("FORM 6A (Revised)", 148, 10, { align: "center" });
    doc.setFontSize(10); doc.setFont("helvetica", "normal");
    doc.text("Consolidated Annual Contribution Statement", 148, 15, { align: "center" });
    
    doc.setFontSize(10);
    doc.text(`Currency Period: ${startMonth} ${startYear} to ${endMonth} ${endYear}`, 14, 25);
    
    doc.setFont("helvetica", "bold");
    doc.text("Name of Establishment:", 14, 32);
    doc.setFont("helvetica", "normal");
    doc.text(companyProfile.establishmentName, 60, 32);
    
    doc.setFont("helvetica", "bold");
    doc.text("Code No:", 220, 32);
    doc.setFont("helvetica", "normal");
    doc.text(companyProfile.pfCode || "", 240, 32);

    // Prepare Data
    // Aggregate per employee
    const tableData = employees.map((emp, i) => {
        let totalWages = 0;
        let totalEE = 0; // 12%
        let totalER_EPF = 0; // 3.67%
        let totalER_EPS = 0; // 8.33%
        
        periods.forEach(p => {
             const record = payrollHistory.find(r => r.employeeId === emp.id && r.month === p.month && r.year === p.year);
             if (record) {
                const wage = record.earnings.basic + record.earnings.da + record.earnings.retainingAllowance;
                const epfWage = emp.isPFHigherWages ? wage : Math.min(wage, config.epfCeiling);
                
                totalWages += Math.round(epfWage);
                totalEE += Math.round(record.deductions.epf);
                totalER_EPS += Math.round(record.employerContributions.eps);
                totalER_EPF += Math.round(record.employerContributions.epf);
             }
        });

        // Skip if all zeros? No, form 6A usually lists all members. But for cleanliness maybe only those with contributions.
        // Let's include if employee has PF number.
        if (!emp.pfNumber) return null;

        return [
            i + 1,
            emp.pfNumber,
            emp.name,
            totalWages,
            totalEE,
            totalER_EPS,
            totalER_EPF,
            0, // Refund
            totalEE + totalER_EPF + totalER_EPS, // Total Remitted (Approx sum)
            '' // Remarks
        ];
    }).filter(row => row !== null);

    // Add Totals Row
    const totals = tableData.reduce((acc, curr) => {
        if (!curr) return acc;
        acc[3] = (acc[3] as number) + (curr[3] as number);
        acc[4] = (acc[4] as number) + (curr[4] as number);
        acc[5] = (acc[5] as number) + (curr[5] as number);
        acc[6] = (acc[6] as number) + (curr[6] as number);
        acc[7] = (acc[7] as number) + (curr[7] as number);
        acc[8] = (acc[8] as number) + (curr[8] as number);
        return acc;
    }, ['', '', 'TOTAL', 0, 0, 0, 0, 0, 0, '']);

    tableData.push(totals);

    autoTable(doc, {
        startY: 40,
        head: [['Sl', 'Acc No', 'Name', 'Wages', 'EE Share', 'EPS Share', 'ER EPF Share', 'Refund', 'Total', 'Rem']],
        body: tableData as any,
        theme: 'grid',
        headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' },
        styles: { fontSize: 8 }
    });
    
    const finalY = (doc as any).lastAutoTable.finalY + 10;
    doc.text("Signature of Employer", 240, finalY + 15);

    doc.save(`Form6A_${startMonth}${startYear}_${endMonth}${endYear}.pdf`);
};
