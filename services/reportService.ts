
import * as XLSX from 'xlsx';
import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';
import { Employee, PayrollResult, StatutoryConfig, Attendance, LeaveLedger, AdvanceLedger } from '../types';
import { BRAND_CONFIG } from '../constants';

// --- Utility: Number to Words (Indian System) ---
export const numberToWords = (num: number): string => {
  const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
  const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

  const regex = /^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/;
  
  const getLT20 = (n: number) => a[Number(n)];
  const getGT20 = (n: number) => b[Number(n[0])] + ' ' + a[Number(n[1])];

  const numToWords = (input: number): string => {
    if (input === 0) return '';
    
    // Handle large numbers by breaking down
    if (input >= 10000000) { // Crore
        return numToWords(Math.floor(input / 10000000)) + 'Crore ' + numToWords(input % 10000000);
    }
    if (input >= 100000) { // Lakh
        return numToWords(Math.floor(input / 100000)) + 'Lakh ' + numToWords(input % 100000);
    }
    if (input >= 1000) { // Thousand
        return numToWords(Math.floor(input / 1000)) + 'Thousand ' + numToWords(input % 1000);
    }
    if (input >= 100) { // Hundred
        return numToWords(Math.floor(input / 100)) + 'Hundred ' + numToWords(input % 100);
    }
    
    // Less than 100
    if (input < 20) return getLT20(input);
    return getGT20(input.toString() as any); // Type cast for string index access
  };

  const integerPart = Math.floor(num);
  if (integerPart === 0) return 'Zero';
  
  return numToWords(integerPart).trim();
};

export const generateExcelReport = (data: any[], sheetName: string, fileName: string) => {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, `${fileName}.xlsx`);
};

export const generatePDFTableReport = (
  title: string,
  headers: string[],
  data: (string | number)[][],
  fileName: string,
  orientation: 'p' | 'l' = 'l',
  footnote?: string
) => {
  const doc = new jsPDF(orientation, 'mm', 'a4');
  
  // Header
  doc.setFontSize(18);
  doc.text(BRAND_CONFIG.companyName, 14, 15);
  doc.setFontSize(11);
  doc.setTextColor(100);
  doc.text(title, 14, 22);
  doc.setTextColor(0);

  // Table
  autoTable(doc, {
    head: [headers],
    body: data,
    startY: 30,
    theme: 'grid',
    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 8 },
    bodyStyles: { fontSize: 7 }, // Smaller font for many columns
    styles: { cellPadding: 1 }
  });

  // Footer & Footnote
  const pageCount = doc.getNumberOfPages();
  const finalY = (doc as any).lastAutoTable.finalY + 10;

  if (footnote) {
      doc.setFontSize(8);
      doc.setFont("helvetica", "italic");
      doc.setTextColor(0); // Black for visibility
      // Ensure footnote doesn't go off page
      const printY = finalY > doc.internal.pageSize.height - 20 ? doc.internal.pageSize.height - 20 : finalY;
      doc.text(footnote, 14, printY);
  }

  for(let i = 1; i <= pageCount; i++) {
     doc.setPage(i);
     doc.setFontSize(8);
     doc.setTextColor(150);
     doc.text(`Generated by ${BRAND_CONFIG.appName} on ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
     doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 25, doc.internal.pageSize.height - 10);
  }

  doc.save(`${fileName}.pdf`);
};

export const generateSimplePaySheetPDF = (
  results: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const headers = [
    'ID', 'Name', 'Days', 
    'Basic', 'DA', 'Retn', 'HRA', 'Conv', 'Spec', 'Othr', 'Encash', 'GROSS', // Earnings
    'PF', 'VPF', 'ESI', 'PT', 'TDS', 'LWF', 'Adv', 'DED', // Deductions
    'NET PAY'
  ];
  
  let hasCode88 = false;

  const data = results.map(r => {
    const emp = employees.find(e => e.id === r.employeeId);
    const special = r.earnings.special1 + r.earnings.special2 + r.earnings.special3;
    const other = r.earnings.washing + r.earnings.attire;
    
    if (r.isCode88) hasCode88 = true;

    // Add Asterisk to PF amount if Code 88 applies
    const pfDisplay = r.isCode88 
        ? `${Math.round(r.deductions.epf)}*` 
        : Math.round(r.deductions.epf);

    return [
      r.employeeId,
      emp?.name || '',
      r.payableDays,
      Math.round(r.earnings.basic),
      Math.round(r.earnings.da),
      Math.round(r.earnings.retainingAllowance),
      Math.round(r.earnings.hra),
      Math.round(r.earnings.conveyance),
      Math.round(special),
      Math.round(other),
      Math.round(r.earnings.leaveEncashment),
      Math.round(r.earnings.total),
      pfDisplay, // Use formatted PF display
      Math.round(r.deductions.vpf),
      Math.round(r.deductions.esi),
      Math.round(r.deductions.pt),
      Math.round(r.deductions.it),
      Math.round(r.deductions.lwf),
      Math.round(r.deductions.advanceRecovery),
      Math.round(r.deductions.total),
      Math.round(r.netPay)
    ];
  });
  
  const footnote = hasCode88 
    ? "* Code on Social Security 2020 [ Clause 88 ] impact on PF Contribution" 
    : undefined;

  generatePDFTableReport(`Pay Sheet - ${month} ${year}`, headers, data as any[][], `PaySheet_${month}_${year}`, 'l', footnote);
};

export const generatePaySlipsPDF = (
  payrollResults: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('p', 'mm', 'a4');
  
  payrollResults.forEach((res, index) => {
    if (index > 0) doc.addPage();
    const emp = employees.find(e => e.id === res.employeeId);
    if (!emp) return;

    // --- Header ---
    doc.setFillColor(241, 245, 249); // Slate-100
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(30, 41, 59);
    doc.text(BRAND_CONFIG.companyName.toUpperCase(), 105, 18, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(71, 85, 105);
    doc.text("Industrial Estate, Chennai, Tamil Nadu", 105, 25, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(15, 23, 42);
    doc.text(`PAY SLIP - ${month.toUpperCase()} ${year}`, 105, 35, { align: 'center' });

    // --- Employee Details Box ---
    doc.setDrawColor(203, 213, 225);
    doc.rect(14, 45, 182, 35);
    
    const leftX = 18;
    const rightX = 110;
    let y = 52;
    const inc = 6;

    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text("Employee Name:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.name, leftX + 30, y);
    
    doc.setFont("helvetica", "bold");
    doc.text("Designation:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.designation, rightX + 25, y);

    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("Employee ID:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.id, leftX + 30, y);

    doc.setFont("helvetica", "bold");
    doc.text("Department:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.division, rightX + 25, y);

    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("Bank A/c:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.bankAccount, leftX + 30, y);

    doc.setFont("helvetica", "bold");
    doc.text("Days Paid:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(`${res.payableDays} / ${res.daysInMonth}`, rightX + 25, y);
    
    y += inc;
    doc.setFont("helvetica", "bold");
    doc.text("UAN No:", leftX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.uanc || 'N/A', leftX + 30, y);
    
    doc.setFont("helvetica", "bold");
    doc.text("PF No:", rightX, y);
    doc.setFont("helvetica", "normal");
    doc.text(emp.pfNumber || 'N/A', rightX + 25, y);

    // --- Financials Table ---
    const startY = 85;
    
    const pfAmountStr = res.isCode88 
        ? `${res.deductions.epf.toFixed(2)}*` 
        : res.deductions.epf.toFixed(2);

    autoTable(doc, {
        startY: startY,
        margin: { left: 14, right: 14 },
        head: [['Earnings', 'Amount (Rs.)', 'Deductions', 'Amount (Rs.)']],
        body: [
            ['Basic Pay', res.earnings.basic.toFixed(2), 'Provident Fund', pfAmountStr],
            ['DA', res.earnings.da.toFixed(2), 'Professional Tax', res.deductions.pt.toFixed(2)],
            ['Retaining Allowance', res.earnings.retainingAllowance.toFixed(2), 'ESI', res.deductions.esi.toFixed(2)],
            ['HRA', res.earnings.hra.toFixed(2), 'Income Tax Recovery', res.deductions.it.toFixed(2)],
            ['Conveyance', res.earnings.conveyance.toFixed(2), 'VPF', res.deductions.vpf.toFixed(2)],
            ['Special Allowance', (res.earnings.special1 + res.earnings.special2 + res.earnings.special3).toFixed(2), 'LWF', res.deductions.lwf.toFixed(2)],
            ['Other Allowances', (res.earnings.washing + res.earnings.attire).toFixed(2), 'Advance Recovery', res.deductions.advanceRecovery.toFixed(2)],
            ['Leave Encashment', res.earnings.leaveEncashment.toFixed(2), '', ''],
            [{ content: 'Total Earnings', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.earnings.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: 'Total Deductions', styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }, { content: res.deductions.total.toFixed(2), styles: { fontStyle: 'bold', fillColor: [241, 245, 249] } }],
        ],
        theme: 'grid',
        headStyles: { fillColor: [51, 65, 85], textColor: 255, halign: 'center' },
        columnStyles: {
            0: { cellWidth: 65 },
            1: { cellWidth: 26, halign: 'right' },
            2: { cellWidth: 65 },
            3: { cellWidth: 26, halign: 'right' },
        }
    });

    // --- Net Pay Section ---
    const finalY = (doc as any).lastAutoTable.finalY + 10;
    
    doc.setDrawColor(59, 130, 246); // Blue border
    doc.setLineWidth(0.5);
    doc.rect(14, finalY, 182, 15);
    
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(15, 23, 42);
    doc.text("NET SALARY PAYABLE:", 20, finalY + 10);
    
    doc.setFontSize(14);
    doc.text(`Rs. ${Math.round(res.netPay).toLocaleString('en-IN')}/-`, 180, finalY + 10, { align: 'right' });

    // --- Amount in Words ---
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(30, 41, 59);
    const amountWords = numberToWords(Math.round(res.netPay));
    doc.text(`Amount in Words: ${amountWords} Rupees Only`, 14, finalY + 25);

    // --- Footnotes ---
    let footerY = finalY + 35;
    
    if (res.isCode88) {
        doc.setFontSize(8);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(0);
        doc.text("* Code on Social Security 2020 [ Clause 88 ] impact on PF Contribution", 14, footerY);
        footerY += 5;
    }

    // --- Footer ---
    doc.setFontSize(8);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(148, 163, 184);
    doc.text("This is a computer-generated document and does not require a signature.", 105, footerY, { align: 'center' });
  });

  doc.save(`PaySlips_${month}_${year}.pdf`);
};

// --- TAMIL NADU REPORTS START ---

export const generateTNFormR = (
  results: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('l', 'mm', 'a3'); 

  // Header
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("FORM - R", 210, 15, { align: 'center' });
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("REGISTER OF WAGES", 210, 20, { align: 'center' });
  doc.setFont("helvetica", "italic");
  doc.text("[See sub-rule (5) of Rule 11]", 210, 25, { align: 'center' });
  doc.setFont("helvetica", "bold");
  doc.text("THE TAMIL NADU SHOPS AND ESTABLISHMENT ACT, 1947 AND RULES, 1948", 210, 32, { align: 'center' });

  const startY = 40;
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  doc.text(`Name of the Establishment: ${BRAND_CONFIG.companyName}`, 14, startY);
  doc.text(`Name of the Employer / Contractor with Address: Industrial Estate, Chennai`, 14, startY + 7);
  doc.text(`Wage Period: ${month} ${year}`, 300, startY);
  doc.text(`Month: ${month}`, 300, startY + 7);
  doc.text(`Year: ${year}`, 380, startY + 7);

  const headers = [
    [
      { content: 'Serial Number', rowSpan: 2 },
      { content: 'Name of the Person Employed', rowSpan: 2 },
      { content: 'Sex', rowSpan: 2 },
      { content: 'Designation / Nature of work', rowSpan: 2 },
      { content: 'Daily rated / Piece-rated / Monthly rated', rowSpan: 2 },
      { content: 'Wages Period', rowSpan: 2 },
      { content: 'Total No. of days worked', rowSpan: 2 },
      { content: 'Units of work done', rowSpan: 2 },
      { content: 'Daily rate / Piece rate', rowSpan: 2 },
      { content: 'Overtime Rate', rowSpan: 2 },
      { content: 'Wages earned', colSpan: 6, styles: { halign: 'center' } },
      { content: 'Gross Wages', rowSpan: 2 },
      { content: 'Deductions', colSpan: 4, styles: { halign: 'center' } },
      { content: 'Net Wages', rowSpan: 2 },
      { content: 'Signature', rowSpan: 2 },
      { content: 'Total unpaid amounts', rowSpan: 2 },
    ],
    [
      'Basic Wages', 'Dearness Allowance', 'Other Allowances', 'Overtime earned', 'Leave wages', 'Total',
      'Provident Fund', 'ESI', 'Other Deduction', 'Fine'
    ]
  ];

  const data = results.map((r, i) => {
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return [];

    const otherAllowances = r.earnings.hra + r.earnings.conveyance + r.earnings.washing + r.earnings.attire + 
                            r.earnings.special1 + r.earnings.special2 + r.earnings.special3;
    const otherDeductions = r.deductions.pt + r.deductions.it + r.deductions.lwf + r.deductions.advanceRecovery;

    return [
      i + 1,
      emp.name,
      '', // Sex
      emp.designation,
      'Monthly',
      'Month',
      r.payableDays,
      '-', // Units
      '-', // Rate
      '-', // OT Rate
      Math.round(r.earnings.basic),
      Math.round(r.earnings.da),
      Math.round(otherAllowances),
      0, // OT
      Math.round(r.earnings.leaveEncashment),
      Math.round(r.earnings.total - 0), // Sub total part of wages earned
      Math.round(r.earnings.total),
      Math.round(r.deductions.epf + r.deductions.vpf),
      Math.round(r.deductions.esi),
      Math.round(otherDeductions),
      0, // Fine
      Math.round(r.netPay),
      '',
      ''
    ];
  });

  autoTable(doc, {
    head: headers,
    body: data,
    startY: startY + 15,
    theme: 'grid',
    styles: { fontSize: 7, cellPadding: 1, overflow: 'linebreak', halign: 'center', valign: 'middle' },
    headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1, lineColor: 0 },
    columnStyles: {
      1: { cellWidth: 30 }
    }
  });

  doc.save(`TN_FormR_WageRegister_${month}_${year}.pdf`);
};

export const generateTNFormT = (
  results: PayrollResult[],
  employees: Employee[],
  attendances: Attendance[],
  leaveLedgers: LeaveLedger[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('p', 'mm', 'a4');
  
  results.forEach((r, index) => {
    if (index > 0) doc.addPage();
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return;
    
    // Get Leave Data
    const ledger = leaveLedgers.find(l => l.employeeId === r.employeeId) || { el: { balance: 0 }, sl: { balance: 0 }, cl: { balance: 0 } };
    const att = attendances.find(a => a.employeeId === r.employeeId && a.month === month && a.year === year) || { earnedLeave: 0, sickLeave: 0, casualLeave: 0 };

    // --- Header ---
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text("FORM - T", 105, 15, { align: 'center' });
    doc.setFont("helvetica", "normal");
    doc.text("Wage Slip/Leave Card", 105, 20, { align: 'center' });
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("[See sub-rule (6) of Rule 11]", 105, 25, { align: 'center' });

    const startY = 35;
    const lineHeight = 8;
    
    // Table Structure for Form T
    const bodyData = [
        ['1. Name and address of the establishment', BRAND_CONFIG.companyName + ", Industrial Estate, Chennai"],
        ['2. Name of the person employed', emp.name],
        ['3. Father/Husband\'s Name', emp.fatherSpouseName],
        ['4. Designation', emp.designation],
        ['5. Date of entry into service', emp.doj],
        ['6. Wage period', `From: 01-${month.substring(0,3)}-${year}   To: ${r.daysInMonth}-${month.substring(0,3)}-${year}`]
    ];

    autoTable(doc, {
        body: bodyData,
        startY: startY,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
        columnStyles: { 0: { cellWidth: 80 } },
        didParseCell: (data) => {
            data.cell.styles.lineWidth = 0.1;
            data.cell.styles.lineColor = 0;
        }
    });

    let currentY = (doc as any).lastAutoTable.finalY;

    // Wage Earned & Deductions Table
    const financialData = [
        ['7. Wage Earned', '', 'Deductions:', ''],
        ['(a) Basic:', r.earnings.basic.toFixed(2), '(i) Employees Provident Fund', r.deductions.epf.toFixed(2)],
        ['(b) Dearness Allowance', r.earnings.da.toFixed(2), '(ii) Employee State Insurance', r.deductions.esi.toFixed(2)],
        ['(c) House Rent Allowance', r.earnings.hra.toFixed(2), '(iii) Other Deductions', (r.deductions.pt + r.deductions.it + r.deductions.lwf).toFixed(2)],
        ['(d) Overtime Wages', '0.00', '', ''],
        ['(e) Leave Wages', r.earnings.leaveEncashment.toFixed(2), '', ''],
        ['(f) Other Allowances', (r.earnings.total - r.earnings.basic - r.earnings.da - r.earnings.hra - r.earnings.leaveEncashment).toFixed(2), '', ''],
        ['(g) Gross Wages', r.earnings.total.toFixed(2), 'Net Amount Paid', r.netPay.toFixed(2)]
    ];

    autoTable(doc, {
        body: financialData,
        startY: currentY,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 2 },
        didParseCell: (data) => {
            data.cell.styles.lineWidth = 0.1;
            data.cell.styles.lineColor = 0;
            // Merge header like rows if needed, simplified here
        }
    });

    currentY = (doc as any).lastAutoTable.finalY;

    // Leave Table
    const leaveData = [
        ['Leave Availed during the month', `CL: ${att.casualLeave || 0}`, `SL: ${att.sickLeave || 0}`, `EL: ${att.earnedLeave || 0}`, 'M: 0'],
        ['Leave at Credit', `CL: ${ledger.cl.balance}`, `SL: ${ledger.sl.balance}`, `EL: ${ledger.el.balance}`, 'M: 0']
    ];

    autoTable(doc, {
        body: leaveData,
        startY: currentY,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 2, halign: 'center' },
        columnStyles: { 0: { cellWidth: 60, halign: 'left' } },
        headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1 }
    });

    currentY = (doc as any).lastAutoTable.finalY + 30;

    doc.text("Signature of the Employer/Manager/", 14, currentY);
    doc.text("or any other Authorised Person", 14, currentY + 5);

    doc.text("Signature or Thumb Impression", 140, currentY);
    doc.text("of the person Employed", 140, currentY + 5);
  });

  doc.save(`TN_FormT_WageSlip_${month}_${year}.pdf`);
};

export const generateTNFormP = (
  results: PayrollResult[],
  employees: Employee[],
  advanceLedgers: AdvanceLedger[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('l', 'mm', 'a4');

  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Tamil Nadu Shops And Establishments Rules", 148, 10, { align: 'center' });
  doc.text("FORM P", 148, 16, { align: 'center' });
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("See sub rule (4) of Rule 11", 148, 21, { align: 'center' });
  doc.setFont("helvetica", "bold");
  doc.text("Register of Advance Paid, Deductions for Damages or Losses and Fines", 148, 28, { align: 'center' });

  const startY = 35;
  doc.setFont("helvetica", "normal");
  doc.text(`Name and Address of Establishment: ${BRAND_CONFIG.companyName}, Industrial Estate, Chennai`, 14, startY);
  doc.text(`Month: ${month}`, 230, startY);
  doc.text(`Year: ${year}`, 270, startY);

  const headers = [
    [
      { content: 'Sl. No.', rowSpan: 2 },
      { content: 'Name of the person employed', rowSpan: 2 },
      { content: 'Father\'s /Husband\'s name', rowSpan: 2 },
      { content: 'Employee No', rowSpan: 2 },
      { content: 'Designation', rowSpan: 2 },
      { content: 'Advance Paid', colSpan: 4, styles: { halign: 'center' } },
      { content: 'Deduction for Damages/Loss', colSpan: 5, styles: { halign: 'center' } },
      { content: 'Fines', colSpan: 4, styles: { halign: 'center' } },
      { content: 'Remarks', rowSpan: 2 }
    ],
    [
      'Date of payment', 'Amount Paid', 'No of instalments', 'Date recovery completed', // Advance
      'Damage/Loss Caused', 'Date of Notice', 'Amount Deduction', 'No of instalments', 'Date completed', // Damages
      'Act/Omission', 'Date of Notice', 'Amount Fine', 'Date recovery' // Fines
    ]
  ];

  const data = employees.map((emp, i) => {
    const adv = advanceLedgers.find(a => a.employeeId === emp.id);
    const hasAdvance = adv && (adv.totalAdvance > 0 || adv.balance > 0);
    const payroll = results.find(r => r.employeeId === emp.id);
    const recovery = payroll ? payroll.deductions.advanceRecovery : 0;

    return [
      i + 1,
      emp.name,
      emp.fatherSpouseName,
      emp.id,
      emp.designation,
      // Advance Section
      hasAdvance ? '-' : '', // Date of payment (Not tracked perfectly, placeholder)
      hasAdvance ? adv.totalAdvance : '',
      hasAdvance ? Math.ceil(adv.totalAdvance / (adv.monthlyInstallment || 1)) : '',
      adv?.balance === 0 && adv.paidAmount > 0 ? `${month} ${year}` : '', // Date completed
      // Damages (Placeholder as not tracked)
      '', '', '', '', '',
      // Fines (Placeholder)
      '', '', '', '',
      ''
    ];
  });

  autoTable(doc, {
    head: headers,
    body: data,
    startY: startY + 10,
    theme: 'grid',
    styles: { fontSize: 6, cellPadding: 1, overflow: 'linebreak', halign: 'center', valign: 'middle' },
    headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1, lineColor: 0 },
    columnStyles: { 1: { cellWidth: 20 } }
  });

  doc.save(`TN_FormP_Advances_${month}_${year}.pdf`);
};

// --- CENTRAL LAW REPORTS END ---

export const generateFormC = (
  results: PayrollResult[],
  employees: Employee[],
  attendances: Attendance[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for Muster Roll

  // Title
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("FORM C", 148, 10, { align: 'center' });
  doc.setFont("helvetica", "italic");
  doc.text("[See section 4(1) proviso (b)(i)]", 148, 15, { align: 'center' });
  doc.setFont("helvetica", "bold");
  doc.text("MUSTERROLL TO BE MAINTAINED BY SMALL ESTABLISHMENTS", 148, 22, { align: 'center' });

  // Header Info
  const startY = 30;
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  
  doc.text(`Name of establishment: ${BRAND_CONFIG.companyName}`, 14, startY);
  doc.text("Name and address of employer: _____________________________", 150, startY);
  doc.text(`Address (Local): Industrial Estate, Chennai`, 14, startY + 6);
  doc.text(`Wage period: ${month} ${year}`, 150, startY + 6);
  doc.text(`(Permanent): ____________________________`, 14, startY + 12);

  const headers = [
    [
      { content: 'Serial\nNumber', rowSpan: 1 },
      { content: 'Name of\nthe\nemployee', rowSpan: 1 },
      { content: 'Date of\nemployment', rowSpan: 1 },
      { content: 'Permanent\naddress', rowSpan: 1 },
      { content: 'Age\nor\ndate\nof\nbirth', rowSpan: 1 },
      { content: 'Father\'s or\nhusband\'s\nname', rowSpan: 1 },
      { content: 'For the period\nending ____\nNumber of units of\nwork done\nduring____', rowSpan: 1 },
      { content: 'Total\nattendance', rowSpan: 1 },
      { content: 'Total\novertime\nworked', rowSpan: 1 },
      { content: 'Total production in\ncase of piece-rated\nworkers', rowSpan: 1 },
      { content: 'Compensatory rest\n\nBrought forward\nfrom previous\nwage period', rowSpan: 1 },
      { content: 'Compensatory rest\n\nGiven during the\nwage period', rowSpan: 1 },
      { content: 'Signature of Inspector\nwith date', rowSpan: 1 },
      { content: 'Remarks', rowSpan: 1 }
    ]
  ];

  const data = employees.map((emp, i) => {
    const att = attendances.find(a => a.employeeId === emp.id && a.month === month && a.year === year) || { presentDays: 0 };
    return [
      i + 1,
      emp.name,
      emp.doj,
      `${emp.city}, ${emp.state}`,
      emp.dob,
      emp.fatherSpouseName,
      `${month} ${year}`,
      att.presentDays,
      '0', // Overtime
      'N/A', // Production
      '-', // Rest BF
      '-', // Rest Given
      '', // Inspector
      '' // Remarks
    ];
  });

  autoTable(doc, {
    head: headers,
    body: data,
    startY: startY + 20,
    theme: 'grid',
    styles: { fontSize: 7, cellPadding: 1, overflow: 'linebreak', halign: 'center', valign: 'middle' },
    headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1, lineColor: 0 },
    columnStyles: {
      1: { cellWidth: 20 },
      3: { cellWidth: 25 },
    }
  });

  // Footer notes as per image
  const finalY = (doc as any).lastAutoTable.finalY + 10;
  doc.setFontSize(8);
  doc.text("Notes: 1. In the case of daily-rated workers, the extent of overtime done on each occasion has to be reflected...", 14, finalY, { maxWidth: 260 });
  doc.text("Signature of the employer with full name in capitals.", 220, finalY + 20);
  doc.text("Date.......................", 14, finalY + 20);
  doc.text("Place......................", 14, finalY + 25);

  doc.save(`FormC_MusterRoll_${month}_${year}.pdf`);
};

export const generateFormB = (
  results: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('l', 'mm', 'a3'); // A3 for more columns in Form B

  // 1. Header
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("FORM B", 210, 15, { align: 'center' });
  doc.setFontSize(10);
  doc.setFont("helvetica", "italic");
  doc.text("[See section 4(1) proviso (b)(i)]", 210, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("REGISTER OF WAGES REQUIRED TO BE MAINTAINED BY SMALL ESTABLISHMENTS", 210, 28, { align: 'center' });
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.text("(To be maintained within seven days of the expiry of the wage period)", 210, 33, { align: 'center' });

  // 2. Establishment Info
  const startY = 40;
  doc.text(`Name of establishment: ${BRAND_CONFIG.companyName}`, 14, startY);
  doc.text("Name and address of employer: ____________________________", 150, startY);
  
  doc.text("Address (Local): Industrial Estate, Chennai", 14, startY + 7);
  doc.text("Nature of work: _____________________________", 150, startY + 7);
  
  doc.text(`(Permanent): ____________________________`, 14, startY + 14);
  doc.text(`Wage period: ${month} ${year}`, 150, startY + 14);

  doc.line(14, startY + 18, 400, startY + 18);

  // 3. Table
  const headers = [
    [
      { content: 'Sl', rowSpan: 2 },
      { content: 'Name of the employee', rowSpan: 2 },
      { content: 'Sex', rowSpan: 2 },
      { content: 'Designation', rowSpan: 2 },
      { content: 'Classification', rowSpan: 2 },
      { content: 'Father/Husband Name', rowSpan: 2 },
      { content: 'Days Worked', rowSpan: 2 },
      { content: 'Wages earned', colSpan: 9, styles: { halign: 'center' } },
      { content: 'Deductions', colSpan: 8, styles: { halign: 'center' } },
      { content: 'Net Payable', rowSpan: 2 },
      { content: 'Signature', rowSpan: 2 },
      { content: 'Remarks', rowSpan: 2 },
    ],
    [
      'Basic (Stat)', 'Basic (Act)', 'DA', 'OT', 'Bonus', 'Mat.', 'Grat.', 'Other', 'Total',
      'Adv', 'Fines', 'PF (Er)', 'PF (Ee)', 'ESI (Er)', 'ESI (Ee)', 'Other', 'Total'
    ]
  ];

  const data = results.map((r, i) => {
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return [];

    const otherAllowances = r.earnings.hra + r.earnings.conveyance + r.earnings.washing + r.earnings.attire + 
                            r.earnings.special1 + r.earnings.special2 + r.earnings.special3 + r.earnings.leaveEncashment;
    
    // PF Employer Share
    const pfEr = Math.round(r.employerContributions.epf + r.employerContributions.eps);
    // PF Employee Share
    const pfEe = Math.round(r.deductions.epf + r.deductions.vpf);
    
    // ESI Employer
    const esiEr = Math.round(r.employerContributions.esi);
    // ESI Employee
    const esiEe = Math.round(r.deductions.esi);

    // Other Deductions (PT + IT + LWF)
    const otherDed = Math.round(r.deductions.pt + r.deductions.it + r.deductions.lwf);

    return [
      i + 1,
      emp.name,
      '', 
      emp.designation,
      'Permanent',
      emp.fatherSpouseName,
      r.payableDays,
      Math.round(r.earnings.basic),
      Math.round(r.earnings.basic),
      Math.round(r.earnings.da),
      0, 
      Math.round(r.earnings.bonus),
      0, 
      0, 
      Math.round(otherAllowances),
      Math.round(r.earnings.total),
      Math.round(r.deductions.advanceRecovery),
      0, 
      pfEr,
      pfEe,
      esiEr,
      esiEe,
      otherDed,
      Math.round(r.deductions.total), 
      Math.round(r.netPay),
      '', 
      '' 
    ];
  });

  autoTable(doc, {
    head: headers,
    body: data,
    startY: startY + 20,
    theme: 'grid',
    styles: { fontSize: 7, cellPadding: 1, overflow: 'linebreak' },
    headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1, lineColor: 0, halign: 'center', valign: 'middle' },
    columnStyles: {
      1: { cellWidth: 25 }, 
      3: { cellWidth: 20 }, 
      5: { cellWidth: 20 }, 
    }
  });

  const finalY = (doc as any).lastAutoTable.finalY + 20;
  
  doc.setFontSize(9);
  doc.text("Signature of the employer with full name in capitals.", 300, finalY, { align: 'right' });
  doc.text("Date: __________________", 14, finalY);
  doc.text("Place: __________________", 14, finalY + 7);

  doc.save(`FormB_RegisterOfWages_${month}_${year}.pdf`);
};

export const generateCentralWageSlip = (
  results: PayrollResult[],
  employees: Employee[],
  month: string,
  year: number
) => {
  const doc = new jsPDF('p', 'mm', 'a4');
  
  results.forEach((r, index) => {
    if (index > 0 && index % 2 === 0) doc.addPage();
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return;

    const yOffset = (index % 2) * 140; 
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("FORM XIX", 105, yOffset + 10, { align: 'center' });
    doc.setFont("helvetica", "normal");
    doc.text("[See Rule 78(1)(b)]", 105, yOffset + 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text("WAGE SLIP", 105, yOffset + 22, { align: 'center' });

    doc.setFontSize(9);
    const startY = yOffset + 30;
    doc.text(`Name and Address of Contractor: ${BRAND_CONFIG.companyName}`, 14, startY);
    doc.text("Nature and location of work: _______________________", 120, startY);
    
    doc.text(`Name and Father's/Husband's name of the workman: ${emp.name} / ${emp.fatherSpouseName}`, 14, startY + 6);
    doc.text(`For the Week/Fortnight/Month ending: ${month} ${year}`, 14, startY + 12);

    const otherAllowances = r.earnings.hra + r.earnings.conveyance + r.earnings.washing + r.earnings.attire + 
                            r.earnings.special1 + r.earnings.special2 + r.earnings.special3 + r.earnings.leaveEncashment;
    
    const otherDeductions = r.deductions.pt + r.deductions.it + r.deductions.lwf + r.deductions.advanceRecovery;

    autoTable(doc, {
        startY: startY + 15,
        theme: 'grid',
        head: [['1. No. of days worked', '2. No. of units of work done', '3. Rate of daily wages/piece rate', '4. Amount of overtime wages', '5. Gross wages payable', '6. Deductions (if any)', '7. Actual wages paid']],
        body: [[
            r.payableDays,
            '-',
            (r.earnings.basic / r.daysInMonth).toFixed(2), 
            '0',
            Math.round(r.earnings.total),
            Math.round(r.deductions.total),
            Math.round(r.netPay)
        ]],
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0.1, lineColor: 0 }
    });

    const breakdownY = (doc as any).lastAutoTable.finalY + 5;
    doc.setFontSize(8);
    doc.text("Breakdown of Earnings & Deductions:", 14, breakdownY);
    
    autoTable(doc, {
        startY: breakdownY + 3,
        theme: 'plain',
        body: [
            ['Basic', Math.round(r.earnings.basic), 'PF (Employee)', Math.round(r.deductions.epf)],
            ['DA', Math.round(r.earnings.da), 'ESI (Employee)', Math.round(r.deductions.esi)],
            ['Others', Math.round(otherAllowances), 'Others', Math.round(otherDeductions)]
        ],
        styles: { fontSize: 7, cellPadding: 1 }
    });

    const sigY = (doc as any).lastAutoTable.finalY + 15;
    doc.text("Initials of the Contractor or his representative", 180, sigY, { align: 'right' });

    if (index % 2 === 0) {
        doc.setDrawColor(200);
        doc.setLineDash([2, 2], 0);
        doc.line(10, 135, 200, 135);
        doc.setLineDash([], 0);
    }
  });

  doc.save(`Central_WageSlips_${month}_${year}.pdf`);
};

export const generatePFForm12A = (
  results: PayrollResult[],
  employees: Employee[],
  config: StatutoryConfig,
  month: string,
  year: number
) => {
  const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

  // --- Aggregate Logic ---
  let totalPFWages = 0;
  let totalEPFWages = 0;
  let totalEPSWages = 0;
  let totalEDLIWages = 0;
  let totalAdminWages = 0;

  let totalEEShare = 0;
  let totalER_EPF = 0;
  let totalER_EPS = 0;

  // Calculate Aggregates
  results.forEach(r => {
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return;

    // Wage Reconstruction (Same logic as payroll engine)
    const basic = r.earnings.basic;
    const da = r.earnings.da;
    const retaining = r.earnings.retainingAllowance;
    const wageA = basic + da + retaining;
    const wageB = r.earnings.total;
    const wageC = wageB - wageA;
    
    let wageD = 0;
    if (wageB > 0 && (wageC/wageB) > 0.5) {
        wageD = wageC - (wageB * 0.5);
    }
    const grossPFWage = Math.round(wageA + wageD);

    // Apply caps based on employee config
    const epfWage = emp.isPFHigherWages ? grossPFWage : Math.min(grossPFWage, config.epfCeiling);
    
    // EPS Wage logic
    const pfWageForEmployer = emp.isEmployerPFHigher ? grossPFWage : Math.min(grossPFWage, config.epfCeiling);
    const epsWage = Math.min(pfWageForEmployer, config.epfCeiling);

    // Accumulate
    totalPFWages += grossPFWage;
    totalEPFWages += epfWage;
    totalEPSWages += epsWage;
    totalEDLIWages += epsWage; // Standard practice: EDLI capped same as EPS
    totalAdminWages += epfWage; // Admin charges on EPF wage

    totalEEShare += r.deductions.epf;
    totalER_EPF += r.employerContributions.epf;
    totalER_EPS += r.employerContributions.eps;
  });

  const totalEDLI_Amt = Math.round(totalEDLIWages * 0.005);
  const totalAdmin_Amt = Math.round(totalAdminWages * 0.005);
  
  // --- PDF Generation ---

  // 1. Red Title
  doc.setFontSize(14);
  doc.setTextColor(180, 0, 0); // Red
  doc.setFont("helvetica", "bold");
  doc.text("PF_Form12A (Revised)", 148, 15, { align: 'center' });

  // 2. Establishment Info
  doc.setFontSize(10);
  doc.setTextColor(0); // Black
  doc.text("(Only for Un-Exempeted Establishment)", 14, 25);
  
  doc.text("Name Address of Establishment", 14, 32);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text(BRAND_CONFIG.companyName.toUpperCase(), 14, 38);
  doc.setFontSize(10);
  doc.text("Industrial Estate, Chennai, TN", 14, 44);
  
  // Address Line Red
  doc.setTextColor(180, 0, 0);
  doc.setFontSize(9);
  doc.text("#6, VANAGARAM MAIN ROAD AYNAMBAKKA", 14, 50);

  // Center Info
  doc.setTextColor(0);
  doc.setFontSize(9);
  const centerX = 120;
  doc.text("|  Employees Providend Fund And Misc. Provision Act 1952", centerX, 32);
  doc.text("|  Employees Pention Scheme [Paragraph 20 (4)]", centerX, 38);
  doc.text("|  Currentcy Period from", centerX, 44);
  doc.text(`|  Statement of Contribution for the Month of   ${month.substring(0,3)}  ${year}`, centerX, 50);
  
  // Highlight Box for Date
  doc.setFillColor(255, 255, 0); // Yellow
  doc.rect(centerX + 65, 46, 25, 5, 'F');
  doc.text(`${month.substring(0,3)}  ${year}`, centerX + 68, 50);

  // Right Side Info
  const rightX = 220;
  doc.text("|  (To be Filled by the EPFO", rightX, 32);
  doc.text("|  Establishment Status", rightX, 38);
  doc.text("|  Group Code", rightX, 44);
  doc.text("|  Establishment Code", rightX, 50);

  // 3. Separator
  doc.setDrawColor(180, 0, 0);
  doc.setLineWidth(0.5);
  doc.line(14, 55, 283, 55);

  // 4. Report Title (Red Brown)
  doc.setFontSize(12);
  doc.setTextColor(165, 42, 42); // Brown/Red
  doc.text("PF ECR_UAN_CALCULATION SHEET", 148, 62, { align: 'center' });
  doc.line(14, 65, 283, 65);

  // 5. TRRN / Date Row
  doc.setFillColor(255, 255, 0);
  doc.rect(80, 70, 25, 8, 'F');
  doc.rect(170, 70, 25, 8, 'F');
  doc.setTextColor(0);
  doc.setFontSize(12);
  doc.text("TRRN", 85, 75);
  doc.text("Date", 175, 75);

  // 6. PF Wages Row
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("PF-Wages", 30, 88);
  doc.setFont("helvetica", "bolditalic");
  doc.text(Math.round(totalPFWages).toString(), 80, 88);

  // Headers for Table
  doc.setFont("helvetica", "bold");
  doc.text("Employee Share", 110, 88);
  doc.text("Employer Share", 160, 88);
  doc.text("Total", 230, 88);

  doc.setDrawColor(180, 0, 0);
  doc.setLineWidth(0.5);
  doc.line(30, 92, 270, 92);

  // 7. Table Content
  let y = 105;
  const col1 = 30;
  const col2 = 80; // Wages
  const col3 = 110; // Rate 1 / Label
  const col4 = 135; // Share 1
  const col5 = 160; // Rate 2 / Label
  const col6 = 185; // Share 2
  const col7 = 230; // Total

  doc.setFontSize(10);
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");

  // Row 1: EPF
  doc.text("EPF_Wages (12%+3.67%)", col1, y);
  doc.text(Math.round(totalEPFWages).toString(), col2, y);
  
  doc.setFont("helvetica", "bold");
  doc.text("12%", col3, y);
  doc.setFont("helvetica", "normal");
  doc.text(Math.round(totalEEShare).toString(), col4, y);

  doc.setFont("helvetica", "bold");
  doc.text("3.67%", col5, y);
  doc.setFont("helvetica", "normal");
  doc.text(Math.round(totalER_EPF).toString(), col6, y);

  doc.text(Math.round(totalEEShare + totalER_EPF).toString(), col7, y);

  // Row 2: EPS
  y += 15;
  doc.text("EPS_Wages (8.33%)", col1, y);
  doc.text(Math.round(totalEPSWages).toString(), col2, y);
  
  doc.setFont("helvetica", "bold");
  doc.text("8.33%", col5, y);
  doc.setFont("helvetica", "normal");
  doc.text(Math.round(totalER_EPS).toString(), col6, y);

  doc.text(Math.round(totalER_EPS).toString(), col7, y);

  // Row 3: EDLI
  y += 15;
  doc.text("EDLI_Wages (0.50%)", col1, y);
  doc.text(Math.round(totalEDLIWages).toString(), col2, y);
  doc.text(Math.round(totalEDLI_Amt).toString(), col7, y);

  // Row 4: Admin
  y += 15;
  doc.text("Admin_Charges (0.50%)", col1, y);
  doc.text(Math.round(totalAdminWages).toString(), col2, y);
  doc.text(Math.round(totalAdmin_Amt).toString(), col7, y);

  // Row 5: Admin EDLI
  y += 15;
  doc.text("Admin_Charg_EDLI (0.0%)", col1, y);
  doc.text("0", col2, y);
  doc.text("0", col7, y);

  // Separator
  y += 10;
  doc.setDrawColor(200);
  doc.line(col1, y, 270, y);

  // Totals
  y += 10;
  doc.setFont("helvetica", "bold");
  
  // Total Employee Share
  doc.text(Math.round(totalEEShare).toString(), col4 - 10, y); // Adjusted X
  
  // Total Employer Share (Just EPF+EPS as per screenshot logic usually, but let's check screenshot. It shows 257723 which is 190223+67500. So ONLY contributions.)
  doc.text(Math.round(totalER_EPF + totalER_EPS).toString(), col6 - 10, y);

  // Grand Total (Sum of all Totals column)
  const grandTotal = (totalEEShare + totalER_EPF) + totalER_EPS + totalEDLI_Amt + totalAdmin_Amt;
  doc.text(Math.round(grandTotal).toString(), col7, y);

  // Bottom Line
  y += 5;
  doc.setDrawColor(180, 0, 0);
  doc.line(30, y, 270, y);

  // Vertical Lines (Simulated)
  // Left border
  // doc.line(28, 92, 28, y);
  // ... (Can add vertical lines if strictly needed, but clean layout often looks better without clutter)

  doc.save(`PF_Form12A_Revised_${month}_${year}.pdf`);
};

export const generatePFECR = (
  results: PayrollResult[],
  employees: Employee[],
  format: 'Excel' | 'Text',
  fileName: string
) => {
  const headers = ['UAN', 'Member Name', 'Gross Wages', 'EPF Wages', 'EPS Wages', 'EDLI Wages', 'EPF Contri Remitted', 'EPS Contri Remitted', 'EPF EPS Diff Remitted', 'NCP Days', 'Refund of Advances'];
  
  const data = results.map(r => {
    const emp = employees.find(e => e.id === r.employeeId);
    if (!emp) return [];
    
    const epfWages = r.deductions.epf > 0 ? Math.round(r.deductions.epf / 0.12) : 0; 
    const epsWages = r.employerContributions.eps > 0 ? Math.round(r.employerContributions.eps / 0.0833) : 0;
    
    return [
      emp.uanc || '',
      emp.name,
      Math.round(r.earnings.total),
      epfWages,
      epsWages,
      epsWages, 
      Math.round(r.deductions.epf), // EE Share
      Math.round(r.employerContributions.eps), // ER EPS
      Math.round(r.employerContributions.epf), // ER EPF Diff
      Math.max(0, r.daysInMonth - r.payableDays), // NCP Days
      0 // Refund
    ];
  });

  if (format === 'Excel') {
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "PF_ECR");
    XLSX.writeFile(wb, `${fileName}.xlsx`);
  } else {
    // TEXT FORMAT: Removed Header Row as per requirement
    const content = data.map(row => row.join(',')).join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileName}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
  }
};

export const generateESIReturn = (
  results: PayrollResult[],
  employees: Employee[],
  format: 'Excel' | 'PDF',
  fileName: string
) => {
  const headers = ['IP Number', 'IP Name', 'No of Days', 'Total Monthly Wages', 'Reason Code for Zero days', 'Last Working Day'];
  
  const data = results.map(r => {
     const emp = employees.find(e => e.id === r.employeeId);
     if (!emp) return [];
     if (r.deductions.esi === 0 && !emp.esiNumber) return []; 

     return [
       emp.esiNumber || '',
       emp.name,
       r.payableDays,
       Math.round(r.earnings.total),
       r.payableDays === 0 ? '1' : '0', 
       ''
     ];
  }).filter(row => row.length > 0);

  if (format === 'Excel') {
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ESI_Return");
    XLSX.writeFile(wb, `${fileName}.xlsx`);
  } else {
    generatePDFTableReport("ESI Monthly Return", headers, data as any[][], fileName, 'p');
  }
};

export const generatePTReport = (
  results: PayrollResult[],
  employees: Employee[],
  fileName: string
) => {
    const headers = ['Emp ID', 'Name', 'Gross Salary', 'PT Deducted', 'State'];
    const data = results.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return [
            r.employeeId,
            emp?.name || '',
            Math.round(r.earnings.total),
            Math.round(r.deductions.pt),
            emp?.state || 'TN'
        ];
    }).filter(r => Number(r[3]) > 0);

    generatePDFTableReport("Professional Tax Report", headers, data as any[][], fileName, 'p');
};

export const generateTDSReport = (
    results: PayrollResult[],
    employees: Employee[],
    fileName: string
) => {
    const headers = ['Emp ID', 'PAN', 'Name', 'Gross Salary', 'TDS Deducted'];
    const data = results.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        return [
            r.employeeId,
            emp?.pan || '',
            emp?.name || '',
            Math.round(r.earnings.total),
            Math.round(r.deductions.it)
        ];
    }).filter(r => Number(r[4]) > 0);

    generatePDFTableReport("TDS (Income Tax) Report", headers, data as any[][], fileName, 'p');
};

export const generateCodeOnWagesReport = (
    results: PayrollResult[],
    employees: Employee[],
    format: 'Excel' | 'PDF',
    fileName: string
) => {
    // Filter only employees impacted by Code 88 (where Wage D > 0, which corresponds to isCode88 true)
    const impactedResults = results.filter(r => r.isCode88);

    if (impactedResults.length === 0) {
        alert("No employees found impacted by Code on Social Security 2020 (Clause 88) for this period.");
        return;
    }

    const headers = ['ID', 'Name', 'Gross Wages (B)', 'Basic+DA+Ret (A)', 'Allowances (C)', '50% of Gross', 'Excluded Amount (D)', 'PF Wages (A+D)'];
    
    const data = impactedResults.map(r => {
        const emp = employees.find(e => e.id === r.employeeId);
        
        const basic = r.earnings.basic + r.earnings.da + r.earnings.retainingAllowance;
        const gross = r.earnings.total;
        const allowances = gross - basic;
        const fiftyPercent = Math.round(gross * 0.5);
        const wageD = Math.max(0, allowances - fiftyPercent);
        const pfWages = basic + wageD;
        
        return [
            r.employeeId,
            emp?.name || '',
            Math.round(gross),
            Math.round(basic),
            Math.round(allowances),
            fiftyPercent,
            wageD,
            Math.round(pfWages)
        ];
    });

    const reportTitle = "Code on Social Security 2020(Clause 88)";

    if (format === 'Excel') {
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Code_88_Analysis");
        XLSX.writeFile(wb, `${fileName}.xlsx`);
    } else {
        generatePDFTableReport(reportTitle, headers, data as any[][], fileName, 'l');
    }
}
